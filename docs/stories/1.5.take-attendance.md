# Story 1.5: Take Attendance

## Status

**Ready for Review**

## Story

**As a** Sunday School teacher,
**I want** to quickly take attendance for my class with a streamlined interface,
**So that** I can mark all students in under 2 minutes before or after the session.

## Acceptance Criteria

1. Quick attendance button on dashboard opens attendance flow
2. If teacher has multiple classes, show class selector first
3. Today's date is auto-selected with option to change
4. "Mark All Present" button for quick bulk action
5. Each student row shows: avatar, name, status buttons (Present/Absent/Excused/Late)
6. Status buttons are large touch targets (44px+) with clear visual states
7. Optional note field per student (expandable)
8. Live counter shows "X of Y marked" progress
9. Stats summary shows counts per status at bottom
10. Save button confirms and returns to previous page
11. Unsaved changes prompt confirmation on exit
12. All components support dark mode
13. All components are accessible (keyboard navigation, screen reader support)
14. Layout is responsive (optimized for mobile-first)
15. Components support RTL layout for Arabic language

## Tasks / Subtasks

- [x] Task 1: Create AttendanceStatusButton component (AC: 6, 12, 13, 15)
  - [x] Create `src/components/teacher/AttendanceStatusButton.tsx`
  - [x] Support 4 statuses: present, absent, excused, late
  - [x] Large touch targets (44px+)
  - [x] Clear visual states with icons and colors
  - [x] Add keyboard support and aria labels

- [x] Task 2: Create AttendanceStudentRow component (AC: 5, 7, 12, 13, 15)
  - [x] Create `src/components/teacher/AttendanceStudentRow.tsx`
  - [x] Display avatar, name, and status buttons
  - [x] Expandable note field (toggle-based)
  - [x] Show selected status clearly with left border color
  - [x] Click on student opens StudentDrawer

- [x] Task 3: Create AttendanceHeader component (AC: 3, 4, 8, 9, 12, 15)
  - [x] Create `src/components/teacher/AttendanceHeader.tsx`
  - [x] Show class name and formatted date
  - [x] "Mark All Present" quick action button
  - [x] Progress counter "X of Y marked"
  - [x] Stats summary with color-coded status counts

- [x] Task 4: Create TakeAttendancePage (AC: 1, 2, 10, 11, 14)
  - [x] Create `src/app/dashboard/teacher/attendance/page.tsx`
  - [x] Class selector for multiple classes via ClassSelectorClient
  - [x] Student list with attendance rows via TakeAttendanceClient
  - [x] Sticky save button with loading state
  - [x] AlertDialog for unsaved changes confirmation

- [x] Task 5: Create server actions for attendance (AC: 10)
  - [x] Create `src/app/dashboard/teacher/attendance/actions.ts`
  - [x] Implement `getClassAttendance()` - fetch current attendance
  - [x] Implement `saveAttendance()` - save attendance records
  - [x] Implement `getTeacherClassesForAttendance()` - get class list
  - [x] Add proper error handling and validation

- [x] Task 6: Update QuickAttendanceButton (AC: 1, 2)
  - [x] Update `src/components/teacher/QuickAttendanceButton.tsx`
  - [x] Link to new attendance page path `/dashboard/teacher/attendance`
  - [x] Dropdown works for multiple classes

- [x] Task 7: Add i18n translations (AC: 15)
  - [x] Add English translations under `teacher.attendance` namespace
  - [x] Add Arabic translations under `teacher.attendance` namespace

- [ ] Task 8: Write component tests (BLOCKED - No test framework configured)
  - [ ] Test status toggling works correctly
  - [ ] Test "Mark All Present" updates all rows
  - [ ] Test save functionality

## Dev Notes

### Existing Patterns to Follow

**Component Structure:**
```typescript
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"
```

**Existing Components to Reuse:**
- `OptimizedAvatar` from `@/components/ui/optimized-avatar`
- `Button` from `@/components/ui/button`
- `Card` from `@/components/ui/card`
- `Badge` from `@/components/ui/badge`
- `StudentDrawer` from `@/components/teacher`
- `Collapsible` from `@/components/ui/collapsible`

### Status Types

```typescript
type AttendanceStatus = 'present' | 'absent' | 'excused' | 'late' | null;

interface AttendanceRecord {
  studentId: string;
  status: AttendanceStatus;
  notes?: string;
}

interface AttendanceState {
  classId: string;
  date: string; // YYYY-MM-DD
  records: AttendanceRecord[];
  isDirty: boolean;
}
```

### Status Icons & Colors

| Status | Icon | Color |
|--------|------|-------|
| Present | Check | Green |
| Absent | X | Red |
| Excused | AlertTriangle | Amber |
| Late | Clock | Orange |

### Reference Document

Full UI/UX specification: `docs/teacher-dashboard-front-end-spec.md` (Section 4.2 - Screen 5)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 1.0 | Initial story creation | James (Dev) |
| 2026-01-10 | 1.1 | Implementation complete - Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed AttendanceStatusButtonProps interface conflict with React.ButtonHTMLAttributes

### Completion Notes List

- Created AttendanceStatusButton with CVA variants for 4 statuses (present, absent, excused, late)
- Created AttendanceStatusGroup component for easy status selection
- Created AttendanceStudentRow with toggle-able notes field and StudentDrawer integration
- Created AttendanceHeader with stats summary and Mark All Present functionality
- Created TakeAttendancePage with server component and two client components:
  - TakeAttendanceClient: Main attendance marking interface
  - ClassSelectorClient: Class selection for teachers with multiple classes
- Created server actions for attendance CRUD operations
- Updated QuickAttendanceButton to link to new attendance page
- Added full i18n support (English + Arabic) under `teacher.attendance` namespace
- Task 8 (Tests) remains BLOCKED - no test framework configured

### File List

**New Files:**
- `src/components/teacher/AttendanceStatusButton.tsx` - Status button with CVA variants
- `src/components/teacher/AttendanceStudentRow.tsx` - Student row with status and notes
- `src/components/teacher/AttendanceHeader.tsx` - Header with stats and Mark All Present
- `src/app/dashboard/teacher/attendance/page.tsx` - Main attendance page
- `src/app/dashboard/teacher/attendance/TakeAttendanceClient.tsx` - Client attendance interface
- `src/app/dashboard/teacher/attendance/ClassSelectorClient.tsx` - Class selector component
- `src/app/dashboard/teacher/attendance/actions.ts` - Server actions for attendance
- `src/app/dashboard/teacher/attendance/loading.tsx` - Loading state

**Modified Files:**
- `src/components/teacher/index.ts` - Added exports for attendance components
- `src/components/teacher/QuickAttendanceButton.tsx` - Updated route path
- `messages/en.json` - Added `teacher.attendance` translations
- `messages/ar.json` - Added `teacher.attendance` Arabic translations

---

## QA Results

*To be filled by QA Agent*
